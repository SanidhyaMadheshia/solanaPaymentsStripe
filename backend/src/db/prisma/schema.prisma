generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// üß© USER & API KEYS
//
model User {
  id         String     @id @default(cuid())
  clerkId    String     @unique
  email      String     @unique
  name       String?
  pubKey     String[]                         // Solana wallet
  apiKeys    ApiKey[]
  products   Product[]
  invoices   Invoice[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash   String
  label     String?
  revoked   Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([keyHash])
}

//
// üõçÔ∏è PRODUCT & PRICE
//
model Product {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  image       String?
  prices      Price[]
  createdAt   DateTime  @default(now())
}

model Price {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  label      String?
  amount     Decimal  @db.Decimal(20, 8)
  currency   String   // "SOL" or "USDC"
  createdAt  DateTime @default(now())
}

//
// üí∏ INVOICE & PAYMENT
//
model Invoice {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId    String?
  productName  String?
  priceId      String?
  priceAmount  Decimal?       @db.Decimal(20, 8)
  currency     String

  amount       Decimal        @db.Decimal(20, 8)
  solAddress   String?        // Solana receiving address
  status       InvoiceStatus  @default(PENDING)

  expiresAt    DateTime?
  paidAt       DateTime?

  webhookUrl   String?
  txHash       String?

  // üëá FIX: add back the relation to Payment
  payments     Payment[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
}

model Payment {
  id           String         @id @default(cuid())
  invoiceId    String
  invoice      Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  txHash       String         @unique
  amount       Decimal        @db.Decimal(20, 8)
  status       PaymentStatus  @default(UNCONFIRMED)

  detectedAt   DateTime       @default(now())
  confirmedAt  DateTime?

  @@index([invoiceId])
  @@index([txHash])
}

enum PaymentStatus {
  UNCONFIRMED
  CONFIRMED
  FAILED
}
