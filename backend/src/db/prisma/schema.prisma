generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(cuid())
  clerkId    String     @unique
  email      String     @unique
  name       String?
  pubKey     String[]                         // Solana wallet
  apiKeys    ApiKey[]
  products   Product[]
  invoices   Invoice[]
  // sessions   CheckoutSession[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash   String
  label     String?
  revoked   Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([keyHash])
}

model Product {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  image       String?
  prices      Price[]
  createdAt   DateTime  @default(now())
}

model Price {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  label      String
  amount     Decimal  @db.Decimal(20, 8)
  currency   String   // "SOL" or "USDC"
  createdAt  DateTime @default(now())
}


model Invoice {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId    String?
  productName  String?
  priceId      String?
  priceAmount  Decimal?       @db.Decimal(20, 8)
  currency     String
  buyerEmail   String?
  amount       Decimal        @db.Decimal(20, 8)
  solAddress   String?        // Solana receiving address
  status       InvoiceStatus  @default(PENDING)
  successUrl   String?
  cancelUrl    String?
  expiresAt    DateTime?
  paidAt       DateTime?
  sessions     CheckoutSession[]
  numberOfItems Int         @default(1)
  webhookUrl   String?
  txHash       String?

  payments     Payment[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Payment {
  id           String         @id @default(cuid())
  invoiceId    String
  invoice      Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  txHash       String         @unique
  amount       Decimal        @db.Decimal(20, 8)
  status       PaymentStatus  @default(UNCONFIRMED)

  detectedAt   DateTime       @default(now())
  confirmedAt  DateTime?

  @@index([invoiceId])
  @@index([txHash])
}
model CheckoutSession {
  id           String           @id @default(cuid())
  // sessionKey   String           @unique      // Public token like "cs_abc123"

  // userId       String
  // user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  invoiceId    String
  invoice      Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  buyerWallet  String
  buyerEmail   String?
  txHash     String

  socketid    String?
  status       CheckoutStatus   @default(PENDING)
  expiresAt    DateTime         // e.g., now() + 10 minutes
  completedAt  DateTime?

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // @@index([userId])
  @@index([invoiceId])
}
enum CheckoutStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
}


enum PaymentStatus {
  UNCONFIRMED
  CONFIRMED
  FAILED
}
